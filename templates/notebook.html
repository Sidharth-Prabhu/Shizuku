{% extends 'base.html' %}

{% block title %}{{ subject }} - Notebook LM Clone{% endblock %}

{% block sidebar %}
<div class="sidebar">
    <div class="sidebar-header">
        <i class="fas fa-book" style="font-size: 24px; color: var(--primary);"></i>
        <h1>Notebook LM</h1>
    </div>

    <div class="notebooks-list">
        {% for nb in notebooks %}
        <div class="notebook-item {% if nb['id'] == nb_id %}active{% endif %}"
            oncontextmenu="handleNotebookContextMenu(event, {{ nb['id'] }}, '{{ nb['subject']|e }}')"
            onclick="location.href='{{ url_for('notebook', nb_id=nb['id']) }}'">
            <div class="title">{{ nb['subject'] }}</div>
            <div class="meta">
                <span class="badge">{{ nb['material_count'] }} source{{ 's' if nb['material_count'] != 1 else ''
                    }}</span>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="sidebar-footer">
        <form method="POST" action="{{ url_for('create_notebook') }}">
            <div class="input-group">
                <input type="text" name="subject" class="form-control" placeholder="New notebook" required>
                <button class="btn btn-primary" type="submit"><i class="fas fa-plus"></i></button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block navbar %}
<div class="navbar">
    <div class="d-flex align-items-center">
        <div class="navbar-title"><i class="fas fa-book me-2"></i>{{ subject }}</div>
        <small class="text-muted ms-3">{{ materials|length }} source{{ 's' if materials|length != 1 else '' }}</small>
    </div>
    <div class="navbar-actions">
        <button class="btn btn-outline-primary" onclick="document.getElementById('pdfUpload').click()">
            <i class="fas fa-plus me-2"></i>Add PDFs
        </button>
    </div>
</div>
{% endblock %}

{% block sources_panel %}
<div class="sources-panel">
    <div class="sources-header">
        <h3>Sources</h3>
        <small class="text-muted">Select which sources to query from</small>
    </div>

    <div class="sources-content">
        <div class="upload-area" onclick="document.getElementById('pdfUpload').click()">
            <i class="fas fa-cloud-upload-alt"></i>
            <h6>Upload PDFs</h6>
            <p class="text-muted">Click or drag and drop files here</p>
        </div>

        <form method="POST" enctype="multipart/form-data" id="uploadForm">
            <input type="file" name="pdf" id="pdfUpload" accept=".pdf" multiple style="display:none;"
                onchange="document.getElementById('uploadForm').submit()">
        </form>

        {% if materials %}
        <div class="mb-3">
            <h6 class="mb-2">Query from selected sources:</h6>
            <small class="text-muted">Uncheck to exclude from queries</small>
        </div>

        {% for mat in materials %}
        <div class="source-item {% if mat['id'] in selected_sources %}selected{% endif %}"
            onclick="toggleSource({{ mat['id'] }})">
            <div class="icon">
                <i class="fas fa-file-pdf"></i>
            </div>
            <div class="info">
                <div class="filename">{{ mat['file_name'] or mat['pdf_path'] }}</div>
                <div class="path">Uploaded</div>
            </div>
            <input type="checkbox" class="checkbox" name="selected_sources" value="{{ mat['id'] }}" {% if mat['id'] in
                selected_sources %}checked{% endif %} onclick="event.stopPropagation()">
            <i class="fas fa-times text-danger" onclick="deleteMaterial({{ mat['id'] }}); event.stopPropagation()"
                style="cursor:pointer;" title="Delete source"></i>
        </div>
        {% endfor %}
        {% else %}
        <div class="empty-state">
            <i class="fas fa-folder-open"></i>
            <h4>No sources yet</h4>
            <p class="text-muted">Upload PDFs to start asking questions</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block chat_area %}
<div class="chat-area">
    <div class="chat-history" id="chatHistory">
        {% if chat_history %}
        {% for msg, is_user in chat_history %}
        <div class="message-container">
            <div class="{{ 'user-message' if is_user else 'ai-message' }}">
                <div class="message-header">
                    <div class="icon">{{ 'Y' if is_user else 'AI' }}</div>
                    <div class="name">{{ 'You' if is_user else 'Assistant' }}</div>
                </div>
                <div class="message-content">
                    {% if is_user %}
                    {{ msg }}
                    {% else %}
                    {{ msg | safe }}
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="empty-state">
            <i class="fas fa-comment-dots"></i>
            <h4>Start a conversation</h4>
            <p class="text-muted">Ask questions about your selected documents</p>
        </div>
        {% endif %}
    </div>

    <div class="chat-input-container">
        <form method="POST" id="chatForm">
            <div id="selectedSourcesContainer"></div>
            <div class="chat-input-wrapper">
                <input type="text" name="message" placeholder="Ask a question about your sources..." required
                    id="messageInput">
                <button type="submit" id="sendBtn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block studio_panel %}
<div class="studio-panel">
    <div class="studio-header d-flex justify-content-between align-items-center px-3">
        <h3 class="m-0">Studio</h3>
        <button class="btn btn-primary btn-sm" onclick="newNote()">
            <i class="fas fa-plus me-1"></i> Add note
        </button>
    </div>

    <div class="studio-content" id="studioContent">
        <!-- Notes List -->
        <div id="notesList">
            {% if notes %}
            {% for note in notes %}
            <div class="note-item p-3 border rounded mb-2 bg-white border shadow-sm" style="cursor:pointer;"
                onclick="openNote({{ note['id'] }})">
                <strong>{{ note['title'] or 'Untitled Note' }}</strong>
                <small class="d-block text-muted">
                    {{ note['created_at'][:19] | replace('T', ' ') if note['created_at'] else '' }}
                </small>
            </div>
            {% endfor %}
            {% else %}
            <div class="text-center text-muted py-5">
                <i class="fas fa-sticky-note fa-3x mb-3 opacity-50"></i>
                <p>No notes yet. Click "Add note" to create one.</p>
            </div>
            {% endif %}
        </div>

        <!-- Rich Text Editor (hidden by default) -->
        <div id="noteEditor" style="display:none;">
            <input type="text" id="noteTitle" class="form-control form-control-lg mb-3"
                placeholder="Note title (optional)" autocomplete="off">
            <div id="quillEditor" style="height: 380px;"></div>
            <div class="mt-3 text-end">
                <button class="btn btn-secondary me-2" onclick="closeEditor()">Cancel</button>
                <button class="btn btn-success" onclick="saveNote()">Save Note</button>
            </div>
        </div>
    </div>
</div>

<!-- Quill.js -->
<link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>

<script>
    // Initialize Quill Editor
    const quill = new Quill('#quillEditor', {
        theme: 'snow',
        placeholder: 'Start writing your note...',
        modules: {
            toolbar: [
                [{ header: [1, 2, 3, 4, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ list: 'ordered' }, { list: 'bullet' }],
                [{ script: 'sub' }, { script: 'super' }],
                [{ indent: '-1' }, { indent: '+1' }],
                [{ color: [] }, { background: [] }],
                [{ align: [] }],
                ['link', 'image', 'video'],
                ['code-block', 'blockquote'],
                ['clean']
            ]
        }
    });

    let currentNoteId = null;

    function newNote() {
        currentNoteId = null;
        document.getElementById('noteTitle').value = '';
        quill.setContents([]);
        document.getElementById('notesList').style.display = 'none';
        document.getElementById('noteEditor').style.display = 'block';
        document.getElementById('noteTitle').focus();
    }

    function openNote(id) {
        currentNoteId = id;
        fetch(`/get_note/${id}`)
            .then(r => r.json())
            .then(data => {
                document.getElementById('noteTitle').value = data.title || '';
                quill.root.innerHTML = data.content || '';
                document.getElementById('notesList').style.display = 'none';
                document.getElementById('noteEditor').style.display = 'block';
            })
            .catch(() => alert('Failed to load note'));
    }

    function closeEditor() {
        currentNoteId = null;
        document.getElementById('noteEditor').style.display = 'none';
        document.getElementById('notesList').style.display = 'block';
    }

    function saveNote() {
        const title = document.getElementById('noteTitle').value.trim();
        const content = quill.root.innerHTML;

        const url = currentNoteId
            ? `/update_note/${currentNoteId}`
            : `/save_note/{{ nb_id }}`;

        fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: title || 'Untitled Note', content })
        })
            .then(() => location.reload())
            .catch(() => alert('Save failed'));
    }

    // Existing chat & working chat/source scripts below (unchanged)
    function handleNotebookContextMenu(event, id, name) {
        event.preventDefault();
        showContextMenu(event, id, name);
    }

    function updateSelectedSources() {
        const checkboxes = document.querySelectorAll('input[name="selected_sources"]:checked');
        const selectedIds = Array.from(checkboxes).map(cb => cb.value);
        const container = document.getElementById('selectedSourcesContainer');
        container.innerHTML = '';
        selectedIds.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'selected_sources';
            input.value = id;
            container.appendChild(input);
        });
    }

    function toggleSource(id) {
        const checkbox = document.querySelector(`input[value="${id}"]`);
        checkbox.checked = !checkbox.checked;
        updateSelectedSources();
        const sourceItem = checkbox.closest('.source-item');
        sourceItem.classList.toggle('selected', checkbox.checked);
    }

    function deleteMaterial(matId) {
        if (confirm('Delete this source?')) {
            fetch(`/delete_material/${matId}`, { method: 'POST' }).then(() => location.reload());
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        updateSelectedSources();
        const messageInput = document.getElementById('messageInput');
        if (messageInput) messageInput.focus();
    });
</script>
{% endblock %}